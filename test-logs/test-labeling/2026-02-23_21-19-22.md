# test-labeling Execution Log

## Metadata
- **Execution time**: 2026-02-23 21:19:22
- **Git Commit**: 2b653cb (branch: main)
- **Scenarios run**: 1, 2, 3, 4

## Code Context

### Recent Backend Change History

```
2b653cb refactor(backend): remove conditional Gemini/OpenAI fallback for model selection
7c4c32a feat(backend): migrate pipeline to Gemini models with async booster and yellow scanner
af398b7 refactor(backend): optimize labeling and final prompts for clarity and token savings
6c69a11 refactor(backend): merge ContextGating into SituationAnalysis
e075459 chore(backend): update default openai model to gpt-4o and add test log
31e584f fix(backend): replace passlib with bcrypt to fix CI test failures
edc5fbb test(backend): add comprehensive test suite (68 tests across 8 modules)
b0ea279 style(backend): fix E501 line-too-long lint errors across 9 files
fedf917 refactor(backend): rename exceptions to *Error convention, remove unused imports
9410f28 refactor: migrate backend from Spring Boot (Java) to FastAPI (Python)
```

### Pipeline Structure Summary

Current pipeline configuration (based on this test's stats event and application.properties):

- **Segmentation**: MeaningSegmenter (max-segment-length: 250, discourse-marker-min-length: 150, enumeration-min-length: 120) + LlmSegmentRefiner (threshold: 40 chars)
- **Labeling**: StructureLabelService (model: gemini-2.5-flash-lite, temp: 0.2, thinking_budget: 512) → 3-tier 14 labels. Fallback: gpt-4o-mini for all-GREEN recovery
- **RED enforcement**: RedLabelEnforcer (definitive instant RED + ambiguous GREEN→YELLOW)
- **Gating**: IdentityBooster (conditional, gemini-2.5-flash-lite), SituationAnalysis (always-on, gpt-4o-mini)
- **Final transform**: gemini-2.5-flash (temp: 0.85, maxTokens: 4000, dynamic thinking 512/768/1024)
- **Validation**: OutputValidator 13 rules, 1 retry on ERROR

### Key Settings (config.py)

```python
openai_model = "gpt-4o"
openai_temperature = 0.85
openai_max_tokens = 2000
openai_max_tokens_paid = 4000
gemini_final_model = "gemini-2.5-flash"
gemini_label_model = "gemini-2.5-flash-lite"
segmenter_max_segment_length = 250
segmenter_discourse_marker_min_length = 150
segmenter_enumeration_min_length = 120
tier_free_max_text_length = 300
tier_paid_max_text_length = 2000
```

### Recent Major Changes

- `2b653cb`: Removed conditional Gemini/OpenAI fallback for model selection — now always uses configured model
- `7c4c32a`: Migrated pipeline to Gemini models (labeling: gemini-2.5-flash-lite, final: gemini-2.5-flash) with async booster and yellow scanner
- `af398b7`: Optimized labeling and final prompts for clarity and token savings

### Infrastructure Issues Discovered During Test

테스트 실행 중 Gemini SDK 호환성 버그가 발견되어 에이전트에 의해 수정됨:

1. **`ai_gemini_service.py`**: `GenerateContentConfig`의 `thinking` 필드명이 SDK v1.64.0에서 `thinking_config`로 변경됨 → 키 수정
2. **`ai_streaming_service.py`**: 동일한 `thinking` → `thinking_config` 키 수정
3. **`structure_label_service.py`**: `THINKING_BUDGET`을 128에서 512로 상향 (Gemini API 최소값 512)
4. **`identity_lock_booster.py`**: `THINKING_BUDGET`을 0에서 `None`으로 변경 (thinking 비활성화)
5. **`multi_model_pipeline.py`**: `compute_thinking_budget()` 반환값을 256/512/768에서 512/768/1024로 상향

이 수정이 없으면 Gemini API 호출 시 Pydantic `extra_forbidden` 에러 또는 thinking budget 최소값 미달 에러 발생.

---

## Per-Scenario Results

### Scenario 1: 학부모/피드백

**Original text**:

안녕하쇼 담임임. 님 애가 시험을 망해서 놀라셨죠. 근데 내 탓하려고 시동걸거 같아서 말해두는데 난 숙제도 제대로 내주고 진도 따라서 스터디 플랜도 잘 짜줬다. 근데 님 애가 안 쳐한거임. 학원 바꿀꺼면 머 ㅃㅃ인데 못바꾸잔아 걍 다음에 잘 보고 싶으면 님도 애를 좀 잡아봐 숙제를 하게.

**세그먼테이션 결과**:

| #  | ID | Text                                                         | Length |
| -- | -- | ------------------------------------------------------------ | ------ |
| 1  | T1 | 안녕하쇼 담임임                                               | 8      |
| 2  | T2 | 님 애가 시험을 망해서 놀라셨죠                                  | 17     |
| 3  | T3 | 근데 내 탓하려고 시동걸거 같아서 말해두는데                      | 24     |
| 4  | T4 | 난 숙제도 제대로 내주고 진도 따라서 스터디 플랜도 잘 짜줬다       | 34     |
| 5  | T5 | 근데 님 애가 안 쳐한거임                                       | 14     |
| 6  | T6 | 학원 바꿀꺼면 머 ㅃㅃ인데 못바꾸잔아                            | 20     |
| 7  | T7 | 걍 다음에 잘 보고 싶으면 님도 애를 좀 잡아봐 숙제를 하게         | 33     |

- **총 세그먼트 수**: 7
- **세그먼테이션 평가**: 전체적으로 의미 단위 분리가 적절하게 이루어짐. T3/T4의 방어적 전제와 자기변호 내용 분리, T6/T7의 경계 모두 정확.

**라벨링 결과**:

| ID  | Tier   | Label               | Text (전문)                                                  |
| --- | ------ | ------------------- | ------------------------------------------------------------ |
| T1  | GREEN  | COURTESY            | 안녕하쇼 담임임                                               |
| T2  | GREEN  | CORE_FACT           | 님 애가 시험을 망해서 놀라셨죠                                  |
| T3  | YELLOW | SELF_JUSTIFICATION  | 근데 내 탓하려고 시동걸거 같아서 말해두는데                      |
| T4  | YELLOW | SELF_JUSTIFICATION  | 난 숙제도 제대로 내주고 진도 따라서 스터디 플랜도 잘 짜줬다       |
| T5  | YELLOW | NEGATIVE_FEEDBACK   | 근데 님 애가 안 쳐한거임                                       |
| T6  | RED    | PURE_GRUMBLE        | 학원 바꿀꺼면 머 ㅃㅃ인데 못바꾸잔아                            |
| T7  | YELLOW | NEGATIVE_FEEDBACK   | 걍 다음에 잘 보고 싶으면 님도 애를 좀 잡아봐 숙제를 하게         |

- **GREEN**: 2 / **YELLOW**: 4 / **RED**: 1

**라벨링 적절성 평가**:

| 평가 항목                    | 판정 | 비고                                                          |
| --------------------------- | ---- | ------------------------------------------------------------ |
| GREEN 정확성                 | PASS | T1(COURTESY), T2(CORE_FACT) 모두 적절                        |
| YELLOW 정확성                | PASS | T3, T4(SELF_JUSTIFICATION), T5, T7(NEGATIVE_FEEDBACK) 모두 적절 |
| RED 정확성                   | WARN | T6: RED 분류 자체는 타당하나, PURE_GRUMBLE보다 **AGGRESSION**이 더 적합. "ㅃㅃ"는 조롱/도발 성격 |
| 경계 사례 판단               | PASS | 사실 형태의 자기변호, 요청 형태의 지시 모두 정확히 식별          |
| RedLabelEnforcer 적용        | WARN | "ㅃㅃ" 패턴을 AGGRESSION으로 강제 전환하지 못함                 |

**핵심 이슈**: T6의 "ㅃㅃ"가 RedLabelEnforcer의 확정 RED 패턴에 매칭되지 않아 AGGRESSION 대신 PURE_GRUMBLE로 분류됨. RED 삭제 결과는 동일하나 라벨 정확도 개선 필요.

**파이프라인 통계**: 총 지연 11,350ms, 템플릿 T08_FEEDBACK, 검증 재시도 0회, WARNING 1건(SOFTEN_CONTENT_DROPPED: T3)

---

### Scenario 2: 직장상사/사과, 항의

**Original text**:

솔직히 말해서 이번 일정 또 밀린거 저 때문만은 아니고 PR-482도 아직 안 닫혔고 김민수도 답을 안 줬고 그래서 v2.3.1 배포가 지금 이 꼴 난건데 아무튼 제가 다 책임져야 하는 분위기라 좀 억울하긴 합니다 근데 어쨌든 오늘 18:00 전에 report_final_v3.docx는 올리긴 올릴거고 링크는 https://drive.company.com/alpha 이거고 제 이메일은 alpha.team.lead@company.co.kr 인데 사실 어제도 새벽 3시까지 했고 허리도 아프고 이거 계속 이런식이면 저도 진짜 모르겠습니다 일단 오늘은 넘기고 나중에 구조 다시 갈아엎든지 하죠

**세그먼테이션 결과**:

| # | ID | Text | Length |
|---|-----|------|--------|
| 1 | T1 | 솔직히 말해서 이번 일정 또 밀린거 저 때문만은 아니고 | 26 |
| 2 | T2 | {{TICKET_1}}도 아직 안 닫혔고 | 16 |
| 3 | T3 | 김민수도 답을 안 줬고 | 10 |
| 4 | T4 | 그래서 {{VERSION_1}} 배포가 지금 이 꼴 난건데 | 27 |
| 5 | T5 | 아무튼 제가 다 책임져야 하는 분위기라 좀 억울하긴 합니다 | 28 |
| 6 | T6 | 근데 어쨌든 오늘 {{TIME_1}} 전에 report_final_v3.docx는 올리긴 올릴거고 | 47 |
| 7 | T7 | 링크는 {{URL_1}} 이거고 | 15 |
| 8 | T8 | 제 이메일은 {{EMAIL_1}} 인데 | 17 |
| 9 | T9 | 사실 어제도 {{TIME_2}}까지 했고 | 17 |
| 10 | T10 | 허리도 아프고 | 6 |
| 11 | T11 | 이거 계속 이런식이면 저도 진짜 모르겠습니다 | 21 |
| 12 | T12 | 일단 오늘은 넘기고 나중에 구조 다시 갈아엎든지 하죠 | 25 |

- **총 세그먼트 수**: 12
- **세그먼테이션 평가**: 전반적으로 적절. T2/T3 분리(독립적 외부 귀책 사유), T9/T10 분리(노력 어필 vs 건강 상태) 합리적.

**라벨링 결과**:

| ID | Tier | Label | Text |
|----|------|-------|------|
| T1 | YELLOW | SELF_JUSTIFICATION | 솔직히 말해서 이번 일정 또 밀린거 저 때문만은 아니고 |
| T2 | YELLOW | ACCOUNTABILITY | {{TICKET_1}}도 아직 안 닫혔고 |
| T3 | YELLOW | ACCOUNTABILITY | 김민수도 답을 안 줬고 |
| T4 | YELLOW | ACCOUNTABILITY | 그래서 {{VERSION_1}} 배포가 지금 이 꼴 난건데 |
| T5 | RED | PURE_GRUMBLE | 아무튼 제가 다 책임져야 하는 분위기라 좀 억울하긴 합니다 |
| T6 | GREEN | CORE_INTENT | 근데 어쨌든 오늘 {{TIME_1}} 전에 report_final_v3.docx는 올리긴 올릴거고 |
| T7 | GREEN | CORE_FACT | 링크는 {{URL_1}} 이거고 |
| T8 | GREEN | CORE_FACT | 제 이메일은 {{EMAIL_1}} 인데 |
| T9 | RED | PRIVATE_TMI | 사실 어제도 {{TIME_2}}까지 했고 |
| T10 | RED | PRIVATE_TMI | 허리도 아프고 |
| T11 | RED | PURE_GRUMBLE | 이거 계속 이런식이면 저도 진짜 모르겠습니다 |
| T12 | GREEN | CORE_INTENT | 일단 오늘은 넘기고 나중에 구조 다시 갈아엎든지 하죠 |

- **GREEN**: 4 / **YELLOW**: 4 / **RED**: 4

**라벨링 적절성 평가**:

| 평가 항목 | 등급 | 핵심 사유 |
|-----------|------|-----------|
| GREEN 정확도 | **WARN** | T12를 GREEN(CORE_INTENT)으로 분류 — "갈아엎든지 하죠"의 투척형 뉘앙스 미포착, YELLOW(EXCESS_DETAIL) 적절 |
| YELLOW 정확도 | **PASS** | T1~T4 서브 라벨 선택이 전반적으로 적절 |
| RED 정확도 | **WARN** | T5를 PURE_GRUMBLE(RED)로 과대 분류 — YELLOW(EMOTIONAL)이 적절. "책임져야 하는 분위기"는 팀 역학 관찰 포함 |
| 경계 사례 판단 | **WARN** | T5, T12 두 곳에서 실제 기능 vs 표면 형태 판단 오류 |
| RedLabelEnforcer | **PASS** | 개입 대상 없음, 미개입 정확 |

**핵심 이슈**:
1. **T5** (가장 심각): "제가 다 책임져야 하는 분위기라 좀 억울하긴 합니다"는 YELLOW(EMOTIONAL)이 정답. 업무 감정 표현 + 팀 상황 관찰을 포함하며, PURE_GRUMBLE 기준("사실 없이 불만만")에 부합하지 않음. RED 삭제 시 발신자의 핵심 감정 맥락 소멸.
2. **T12** (경미): "갈아엎든지 하죠"의 투척형/체념 뉘앙스가 GREEN(CORE_INTENT)으로 처리되어 그대로 보존됨. YELLOW(EXCESS_DETAIL)로 분류하여 프레이밍 재구성이 필요.

---

### Scenario 3: 고객/요청, 피드백

**Original text**:

고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단 귀사 서버 설정이 이상해서 생긴거고 제가 지난번에도 config.yaml이랑 MainService.java 건드리지 말라고 했는데 또 수정하셔서 이 사단이 난거 같습니다 아무튼 현재 010-4921-8823으로 연락주셔도 되고 계좌는 110-123-456789이고 환불 얘기는 좀 과한 것 같고 일단 로그파일 error_dump_2026_02_14.zip 보내주시면 제가 보겠습니다 근데 저도 사람이라 하루종일 이런 대응하면 멘탈 좀 나가긴 합니다

**파이프라인 상태**: ⚠️ **Gemini API 에러로 labeling 단계 실패**. 세그먼테이션까지만 완료. labels/stats 이벤트 미수신.

**세그먼테이션 결과**:

| # | ID | Text | Length |
|---|-----|------|--------|
| 1 | T1 | 고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단 귀사 서버 설정이 이상해서 생긴거 | 51 |
| 2 | T2 | 제가 지난번에도 config.yaml이랑 {{FILE_1}} 건드리지 말라 | 41 |
| 3 | T3 | 했는데 또 수정하셔서 이 사단이 난거 같습니다 | 25 |
| 4 | T4 | 아무튼 현재 {{PHONE_1}}으로 연락주셔도 되고 계좌는 {{ACCOUNT_1}}이고 환불 얘기는 좀 과한 것 같고 일단 로그파일 {{FILE_2}} 보내주시면 제가 보겠습니다 | 100 |
| 5 | T5 | 근데 저도 사람이라 하루종일 이런 대응하면 멘탈 좀 나가긴 합니다 | 36 |

- **총 세그먼트 수**: 5
- **세그먼테이션 평가**:
  - **T1 과소 분리 (WARN)**: "고객님"(COURTESY)과 책임전가 내용이 하나의 세그먼트로 결합. 호칭 분리 실패.
  - **T2/T3 과잉 분리 (WARN)**: "건드리지 말라고 했는데 또 수정하셔서 이 사단이 난거 같습니다"가 의미 단위 중간에서 분리됨. T2가 "말라"에서 끊겨 불완전 문장.
  - **T4 심각한 과소 분리 (WARN)**: 100자에 3개 의미 단위 혼합 — CORE_FACT(연락처/계좌) + NEGATIVE_FEEDBACK("환불 얘기는 좀 과한 것 같고") + REQUEST(로그파일 요청). 단일 라벨 부여 시 반드시 정보 손실.

**기대 라벨링 (API 에러로 실제 미수신, 규칙 기반 기대값)**:

| ID | 기대 Tier | 기대 Label | 근거 |
|----|----------|------------|------|
| T1 | YELLOW | ACCOUNTABILITY | "귀사 서버 설정이 이상해서" — 직접 비난 뉘앙스의 외부 귀책 |
| T2 | YELLOW | NEGATIVE_FEEDBACK | "건드리지 말라" — 상대 행동 지시/판단 하드 트리거 |
| T3 | YELLOW | NEGATIVE_FEEDBACK | "또 수정하셔서 이 사단이" — 상대 행동 결과 부정적 평가 |
| T4 | GREEN (혼합) | CORE_FACT/REQUEST | 3개 기능 혼합으로 단일 라벨 부적합 — NEGATIVE_FEEDBACK 묻힐 위험 |
| T5 | RED | PRIVATE_TMI | "멘탈 좀 나가긴 합니다" — 삭제해도 용건 이해에 지장 없음 |

**라벨링 적절성 평가**:

| 평가 항목 | 등급 | 핵심 사유 |
|-----------|------|-----------|
| GREEN 정확도 | **WARN** | T4가 GREEN으로 갈 경우 내부 NEGATIVE_FEEDBACK("환불 얘기는 좀 과한 것 같고") under-labeling |
| YELLOW 정확도 | **PASS** | T1 ACCOUNTABILITY, T2/T3 NEGATIVE_FEEDBACK 적절 |
| RED 정확도 | **PASS** | T5 PRIVATE_TMI 적절 |
| 경계 사례 판단 | **WARN** | T4의 다중 기능 혼합이 가장 심각 — 세그먼테이션 문제가 라벨링 정확도에 직접 영향 |
| RedLabelEnforcer | **PASS** | 해당 패턴 없어 미개입 정상 |

---

### Scenario 4: 교수/사과

**Original text**:

교수님 이번 과제 제출이 늦어진건 사실 제 잘못도 있지만 JIRA-991 이 계속 꼬여서 그런거고 사실 개인적으로도 집안일이 좀 있었고 그래서 정신이 없었습니다 그래도 결과물은 final_thesis_v1.0.4.pdf로 정리해놨고 https://snu-project-lab.com/upload 여기 업로드 예정인데 솔직히 이런식으로 일정이 빡빡하면 연구 퀄리티가 떨어질 수밖에 없다고 생각합니다 UUID는 123e4567-e89b-12d3-a456-426614174000 이고 어쨌든 늦은건 죄송하지만 저만 탓받는 느낌은 좀 억울하네요

**세그먼테이션 결과**:

| #  | ID  | Text                                                                  | Length |
| -- | --- | --------------------------------------------------------------------- | ------ |
| 1  | T1  | 교수님 이번 과제 제출이 늦어진건 사실 제 잘못도 있지만                        | 31     |
| 2  | T2  | {{TICKET_1}} 이 계속 꼬여서 그런거고                                      | 26     |
| 3  | T3  | 사실 개인적으로도 집안일이 좀 있었고                                         | 20     |
| 4  | T4  | 그래서 정신이 없었습니다                                                    | 13     |
| 5  | T5  | 그래도 결과물은 final_thesis_{{VERSION_1}}.pdf로 정리해놨고                 | 46     |
| 6  | T6  | {{URL_1}} 여기 업로드 예정인데                                             | 21     |
| 7  | T7  | 솔직히 이런식으로 일정이 빡빡하면 연구 퀄리티가 떨어질 수밖에 없다고 생각합니다     | 44     |
| 8  | T8  | UUID는 {{UUID_1}} 이고                                                   | 19     |
| 9  | T9  | 어쨌든 늦은건 죄송하지만                                                    | 13     |
| 10 | T10 | 저만 탓받는 느낌은 좀 억울하네요                                              | 18     |

- **총 세그먼트 수**: 10
- **세그먼테이션 평가**: 전반적으로 적절. T1의 사과+변명 혼합은 수용 가능. T9/T10의 사과와 감정 토로 분리가 우수.

**라벨링 결과**:

| ID  | Tier   | Label              | Text (전문)                                                         |
| --- | ------ | ------------------ | ------------------------------------------------------------------- |
| T1  | YELLOW | SELF_JUSTIFICATION | 교수님 이번 과제 제출이 늦어진건 사실 제 잘못도 있지만                      |
| T2  | YELLOW | ACCOUNTABILITY     | {{TICKET_1}} 이 계속 꼬여서 그런거고                                    |
| T3  | RED    | PRIVATE_TMI        | 사실 개인적으로도 집안일이 좀 있었고                                       |
| T4  | RED    | PRIVATE_TMI        | 그래서 정신이 없었습니다                                                  |
| T5  | GREEN  | CORE_FACT          | 그래도 결과물은 final_thesis_{{VERSION_1}}.pdf로 정리해놨고               |
| T6  | GREEN  | CORE_INTENT        | {{URL_1}} 여기 업로드 예정인데                                           |
| T7  | RED    | PURE_GRUMBLE       | 솔직히 이런식으로 일정이 빡빡하면 연구 퀄리티가 떨어질 수밖에 없다고 생각합니다   |
| T8  | GREEN  | CORE_FACT          | UUID는 {{UUID_1}} 이고                                                 |
| T9  | GREEN  | APOLOGY            | 어쨌든 늦은건 죄송하지만                                                  |
| T10 | RED    | PURE_GRUMBLE       | 저만 탓받는 느낌은 좀 억울하네요                                            |

- **GREEN**: 4 / **YELLOW**: 2 / **RED**: 4

**라벨링 적절성 평가**:

| 평가 항목 | 판정 | 비고 |
|----------|------|------|
| GREEN 정확도 | **PASS** | 4개 GREEN 모두 핵심 콘텐츠를 정확히 포착 |
| YELLOW 정확도 | **PASS** | 서브라벨 선택과 강도 스펙트럼 위치 모두 적절 |
| RED 정확도 | **WARN** | T7(일정/퀄리티 불만)이 PURE_GRUMBLE 대신 NEGATIVE_FEEDBACK(YELLOW)이 더 나은 재작성 전략을 이끌어낼 수 있음 |
| 경계 사례 판단 | **PASS** | 사과-형태 변명(T1), ACCOUNTABILITY/SELF_JUSTIFICATION 구분(T1/T2), 사과+지만 분리(T9/T10) 모두 정확 |
| RedLabelEnforcer 적용 | **PASS** | 해당 패턴 없어 미개입, 정상 |

**핵심 이슈**: T7 "일정이 빡빡하면 연구 퀄리티가 떨어질 수밖에 없다고 생각합니다"는 교수/학교 시스템에 대한 간접 비판으로, NEGATIVE_FEEDBACK(YELLOW)으로 분류하여 "개선 프레임 전환" 재작성이 메시지 완성도에 기여. 완전 삭제 시 발신자의 일정 개선 요청 뉘앙스 소실.

---

## Overall Analysis

### 2-1. 분절 품질 요약

**분절 이슈 패턴**:

| 패턴 | 해당 시나리오 | 설명 |
|------|-------------|------|
| 호칭+내용 미분리 | 시나리오 3 (T1), 시나리오 4 (T1) | "고객님"/"교수님" 호칭과 본문 내용이 하나의 세그먼트로 결합. 시나리오 3에서는 COURTESY와 ACCOUNTABILITY가 혼합되어 라벨 정확도에 직접 영향. 시나리오 4에서는 APOLOGY와 SELF_JUSTIFICATION이 혼합되나 SELF_JUSTIFICATION이 지배적이라 영향 경미 |
| 나열형 접속사 과소 분리 | 시나리오 3 (T4) | 100자 세그먼트에 3개 의미 단위(CORE_FACT + NEGATIVE_FEEDBACK + REQUEST)가 "~고 ~고 ~고" 패턴으로 연결. 단일 라벨 부여 시 반드시 정보 손실 |
| 불완전 문장 경계 분리 | 시나리오 3 (T2/T3) | "건드리지 말라"에서 분리 → T2가 불완전 문장으로 종료. 연결어미 "-라(고)" 위치에서의 분리가 과잉 세그먼테이션 유발 |

시나리오 1, 2는 세그먼테이션 품질이 양호하며 이슈 없음. 시나리오 3에서 세그먼테이션 문제가 집중됨 (과소+과잉 동시 발생).

### 2-2. 라벨링 품질 요약

**반복 오라벨링 패턴**:

| 패턴 | 해당 시나리오 | 설명 | 영향 |
|------|-------------|------|------|
| **EMOTIONAL → PURE_GRUMBLE(RED) 과대 분류** | 시나리오 2 (T5), 시나리오 4 (T7) | 업무 감정 표현이나 간접적 시스템 비판이 포함된 세그먼트가 PURE_GRUMBLE(RED)로 분류되어 완전 삭제 처리됨. PURE_GRUMBLE 기준("사실 없이 불만만")에 부합하지 않는 경우에도 RED 판정 | **심각** — RED 삭제 시 발신자의 감정 맥락/피드백 뉘앙스 완전 소실. 사과+항의 contexts에서 항의 요소가 제거됨 |
| **투척형/체념형 표현 GREEN 과소 분류** | 시나리오 2 (T12) | "갈아엎든지 하죠"와 같은 무성의/체념 뉘앙스가 GREEN(CORE_INTENT)으로 분류. 표면 형태(미래 계획 제안)에 속아 실제 기능(투척형 체념) 미포착 | **경미** — 상사에게 부적절한 표현이 그대로 보존되나, 의미 자체는 유지됨 |
| **RedLabelEnforcer 패턴 누락** | 시나리오 1 (T6) | "ㅃㅃ"(빠이빠이 초성 축약)가 조롱/도발 패턴으로 감지되지 않음. AGGRESSION 대신 PURE_GRUMBLE로 분류 | **경미** — RED 삭제 결과는 동일하나 라벨 정확도 저하 |

**FAIL 항목 상세 분석**:

#### 1. 시나리오 2 T5: "제가 다 책임져야 하는 분위기라 좀 억울하긴 합니다"
- **실제**: RED(PURE_GRUMBLE) → **기대**: YELLOW(EMOTIONAL)
- **근거**: "억울하긴 합니다"는 업무 이슈에 대한 감정 표현(하드 트리거: "direct emotional expression"). "책임져야 하는 분위기"는 팀 역학에 대한 관찰(사실적 관찰 포함). PURE_GRUMBLE 기준인 "사실 정보 없이 불만만으로 구성"에 부합하지 않음.
- **Final Transform 영향**: RED 삭제 시 사과+항의 맥락에서 항의 요소가 완전히 제거되어 메시지 톤이 과도하게 순화됨. 발신자의 현 상황 인식이 누락.

#### 2. 시나리오 4 T7: "일정이 빡빡하면 연구 퀄리티가 떨어질 수밖에 없다고 생각합니다"
- **실제**: RED(PURE_GRUMBLE) → **기대**: YELLOW(NEGATIVE_FEEDBACK)
- **근거**: 교수/학교 시스템에 대한 간접 비판으로, "일정 압박→퀄리티 저하"라는 인과관계 주장이 포함. 구체적 수치/기한은 없으나 연구 환경 피드백으로서 의미 있음. NEGATIVE_FEEDBACK 하드 트리거("상대 시스템/정책에 대한 직접적 판단/비판")에 근접.
- **Final Transform 영향**: RED 삭제 시 발신자가 전달하려던 "일정 개선 필요"라는 핵심 피드백이 완전 소실. YELLOW 처리 시 "연구 일정에 관해 고민되는 부분이 있습니다" 등으로 간접 전환 가능.

#### 3. 시나리오 2 T12: "일단 오늘은 넘기고 나중에 구조 다시 갈아엎든지 하죠"
- **실제**: GREEN(CORE_INTENT) → **기대**: YELLOW(EXCESS_DETAIL)
- **근거**: "갈아엎든지 하죠"는 미래 계획 제안의 표면 형태이나 실제 기능은 투척형 체념 표현. 하드 트리거는 아니나, 소프트 트리거("비정중한 프레이밍")에 해당.
- **Final Transform 영향**: GREEN 보존 시 "갈아엎든지 하죠"라는 무성의한 표현이 상사에게 그대로 전달될 위험. YELLOW 처리 시 "향후 구조 개선을 검토해 보겠습니다" 등으로 프레이밍 전환 가능.

### 2-3. 개선 제안

#### 우선순위 1: System prompt 수정

**1-1. EMOTIONAL vs PURE_GRUMBLE 경계 강화** (시나리오 2 T5, 시나리오 4 T7)

- **대상 파일**: `app/pipeline/prompt_builder.py` — StructureLabel 프롬프트
- **변경 내용**: PURE_GRUMBLE 판정 자문 규칙을 강화하여, "업무 상황 관찰/팀 역학 언급이 포함된 감정 표현"을 EMOTIONAL(YELLOW)로 분류하도록 few-shot 예시 추가:
  ```
  예시 추가:
  - "제가 다 책임져야 하는 분위기라 억울하다" → EMOTIONAL (O) / PURE_GRUMBLE (X)
    이유: "책임져야 하는 분위기"는 팀 역학에 대한 관찰(사실 포함)
  - "이런식으로 일정이 빡빡하면 퀄리티가 떨어질 수밖에 없다" → NEGATIVE_FEEDBACK (O) / PURE_GRUMBLE (X)
    이유: "일정→퀄리티" 인과관계 주장은 시스템 피드백
  ```
- **PURE_GRUMBLE 자문 질문 수정**: "사실 없이 불만만" → "업무/이슈 맥락 정보가 전혀 없이 순수 감정 토로만인가? 상황 관찰, 인과관계, 시스템 비판이 1개라도 있으면 → YELLOW"

**1-2. 투척형/체념형 표현 GREEN 과소 분류 방지** (시나리오 2 T12)

- **대상 파일**: `app/pipeline/prompt_builder.py` — StructureLabel 프롬프트
- **변경 내용**: GREEN 함정 규칙에 "체념형 제안" 패턴 추가:
  ```
  GREEN 함정 5: "~든지 하죠", "~든 말든", "알아서 하세요" 등 투척형/체념형 표현은
  표면상 제안/요청이지만 실제 기능은 무관심/포기 → YELLOW(EXCESS_DETAIL)
  ```

#### 우선순위 2: Server rule 강화

**2-1. RedLabelEnforcer 패턴 확장** (시나리오 1 T6)

- **대상 파일**: `app/pipeline/labeling/red_label_enforcer.py`
- **변경 내용**: 확정 RED 패턴(AGGRESSION)에 "ㅃㅃ"(빠이빠이 초성 축약) 추가. 초성 축약 조롱/도발 패턴 카테고리:
  ```python
  # 확정 RED: 조롱/도발 축약
  _AGGRESSION_PATTERNS.append(r"ㅃㅃ")  # 빠이빠이 조롱
  ```

**2-2. MeaningSegmenter 나열형 분리 강화** (시나리오 3 T4)

- **대상 파일**: `app/pipeline/segmentation/meaning_segmenter.py`
- **변경 내용**: Stage 5 (Enumeration detection)의 트리거 조건을 완화하여, "~고 ~고 ~고" 나열 패턴에서 의미 기능이 다른 항목(예: 사실 전달 → 판단 → 요청)이 혼합된 경우에도 분리하도록 개선. 현재 기준(120자 이상 + 3개 이상 동일 구분자)에 더해 "의미 전환 접속사(아무튼/그런데/일단)" 앞에서 분리하는 규칙 추가.

**2-3. MeaningSegmenter 연결어미 분리 억제** (시나리오 3 T2/T3)

- **대상 파일**: `app/pipeline/segmentation/meaning_segmenter.py`
- **변경 내용**: Stage 2 ambiguous ending suppression 목록에 "-라(고)" 패턴 추가. "~라고 했는데"가 하나의 의미 단위로 유지되도록.

#### 우선순위 3: Pipeline 구조 변경

현재까지 발견된 이슈는 우선순위 1, 2에서 해결 가능하므로 구조 변경은 불필요. 다만 시나리오 3의 Gemini API 에러가 지속될 경우, labeling 단계에도 fallback 모델 전환 로직(현재 all-GREEN recovery에만 존재) 추가를 검토해야 함.

---

## Changes vs Previous Log

First run — no comparison available
