# test-labeling Execution Log

## Metadata

- **Execution time**: 2026-02-24 12:20:23
- **Git Commit**: b4891c7 (branch: main)
- **Scenarios run**: 3, 8, 14

## Code Context

### Recent Backend Change History

```
b4891c7 refactor(backend): streamline labeling prompt and enforce Gemini thinking budget minimum
c69c9ec feat(backend): add informal conjunction validator, fix Gemini thinking config, and enhance pipeline prompts
2b653cb refactor(backend): remove conditional Gemini/OpenAI fallback for model selection
7c4c32a feat(backend): migrate pipeline to Gemini models with async booster and yellow scanner
af398b7 refactor(backend): optimize labeling and final prompts for clarity and token savings
6c69a11 refactor(backend): merge ContextGating into SituationAnalysis
e075459 chore(backend): update default openai model to gpt-4o and add test log
31e584f fix(backend): replace passlib with bcrypt to fix CI test failures
edc5fbb test(backend): add comprehensive test suite (68 tests across 8 modules)
b0ea279 style(backend): fix E501 line-too-long lint errors across 9 files
```

### Pipeline Structure Summary

- **Segmentation**: MeaningSegmenter + LlmSegmentRefiner
- **Labeling**: StructureLabelService (model: gemini-2.5-flash-lite, temp: 0.2, thinking_budget: 512) → 3-tier 14 labels. Fallback: gpt-4o-mini for all-GREEN recovery
- **RED enforcement**: RedLabelEnforcer
- **Gating**: IdentityBooster (conditional, gemini-2.5-flash-lite), SituationAnalysis (always-on, gpt-4o-mini)
- **Final transform**: gemini-2.5-flash (temp: 0.85, maxTokens: 4000, dynamic thinking 512/768/1024)
- **Validation**: OutputValidator, 1 retry on ERROR or retryable WARNING

### Recent Major Changes

- `b4891c7`: labeling 프롬프트 간소화 및 Gemini thinking budget 최소값 강제
- `c69c9ec`: informal conjunction validator 추가, Gemini thinking config 수정, 파이프라인 프롬프트 강화

---

## Per-Scenario Results

### Scenario 3: 고객/요청, 피드백

**Original text**:

고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단 귀사 서버 설정이 이상해서 생긴거고 제가 지난번에도 config.yaml이랑 MainService.java 건드리지 말라고 했는데 또 수정하셔서 이 사단이 난거 같습니다 아무튼 현재 010-4921-8823으로 연락주셔도 되고 계좌는 110-123-456789이고 환불 얘기는 좀 과한 것 같고 일단 로그파일 error_dump_2026_02_14.zip 보내주시면 제가 보겠습니다 근데 저도 사람이라 하루종일 이런 대응하면 멘탈 좀 나가긴 합니다

**세그먼테이션 결과**:

| # | ID | Text | Length |
|---|-----|------|--------|
| 1 | T1 | 고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단 귀사 서버 설정이 이상해서 생긴거 | 51 |
| 2 | T2 | 제가 지난번에도 config.yaml이랑 {{FILE_1}} 건드리지 말라 | 41 |
| 3 | T3 | 했는데 또 수정하셔서 이 사단이 난거 같습니다 | 25 |
| 4 | T4 | 아무튼 현재 {{PHONE_1}}으로 연락주셔도 되고 계좌는 {{ACCOUNT_1}}이고 환불 얘기는 좀 과한 것 같고 | 66 |
| 5 | T5 | 일단 로그파일 {{FILE_2}} 보내주시면 제가 보겠습니다 | 33 |
| 6 | T6 | 근데 저도 사람이라 하루종일 이런 대응하면 멘탈 좀 나가긴 합니다 | 36 |

- **총 세그먼트 수**: 6 (이전 실행 대비 5→6, T5 REQUEST 분리 개선)
- **세그먼테이션 평가**:
  - **T1 호칭+내용 미분리 (지속)**: "고객님"(COURTESY)과 책임전가 내용이 하나의 세그먼트로 결합. 이전 로그에서도 동일 이슈.
  - **T2/T3 불완전 문장 경계 분리 (지속)**: "건드리지 말라"에서 끊겨 T2가 불완전 문장. T3 "했는데 또 수정하셔서..."는 연결 구조.
  - **T4 혼합 (일부 개선)**: 이전 100자→66자로 축소 (REQUEST 부분이 T5로 분리). 그러나 여전히 CORE_FACT(연락처/계좌) + NEGATIVE_FEEDBACK("환불 얘기는 좀 과한 것 같고") 혼합.

**라벨링 결과**:

| ID | Tier | Label | Text (전문) |
|----|------|-------|------------|
| T1 | YELLOW | ACCOUNTABILITY | 고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단 귀사 서버 설정이 이상해서 생긴거 |
| T2 | YELLOW | ACCOUNTABILITY | 제가 지난번에도 config.yaml이랑 {{FILE_1}} 건드리지 말라 |
| T3 | YELLOW | ACCOUNTABILITY | 했는데 또 수정하셔서 이 사단이 난거 같습니다 |
| T4 | GREEN | CORE_INTENT | 아무튼 현재 {{PHONE_1}}으로 연락주셔도 되고 계좌는 {{ACCOUNT_1}}이고 환불 얘기는 좀 과한 것 같고 |
| T5 | GREEN | CORE_INTENT | 일단 로그파일 {{FILE_2}} 보내주시면 제가 보겠습니다 |
| T6 | RED | PRIVATE_TMI | 근데 저도 사람이라 하루종일 이런 대응하면 멘탈 좀 나가긴 합니다 |

- **GREEN**: 2 / **YELLOW**: 3 / **RED**: 1

**라벨링 적절성 평가**:

1. **GREEN 정확성 — WARN**: T4에 "환불 얘기는 좀 과한 것 같고"(NEGATIVE_FEEDBACK)가 포함되어 있으나 GREEN(CORE_INTENT)으로 분류. 연락처/계좌 정보와 혼합되어 단일 라벨로 부정적 판단이 묻힘. 세그먼테이션 의존 이슈.
2. **YELLOW 정확성 — WARN**: T2/T3은 상대방 행동에 대한 직접적 비판/지시("건드리지 말라고 했는데 또 수정하셔서")로 NEGATIVE_FEEDBACK이 더 적합. ACCOUNTABILITY는 외부 원인 귀책 뉘앙스이나, 이 맥락은 상대방 행동 판단(=NEGATIVE_FEEDBACK 하드 트리거)에 해당.
3. **RED 정확성 — PASS**: T6 PRIVATE_TMI 정확.
4. **경계 사례 판단 — WARN**: T1에서 "고객님"(COURTESY)이 ACCOUNTABILITY와 결합되어 호칭 기능 소실.
5. **RedLabelEnforcer — PASS**: 해당 패턴 없어 미개입, 정상.

**Rating: WARN**

핵심 이슈: (1) T2/T3 서브라벨 ACCOUNTABILITY→NEGATIVE_FEEDBACK 오분류, (2) T4 혼합 콘텐츠 under-labeling (세그먼테이션 기인).

파이프라인 통계: 총 지연 20,690ms, 템플릿 T02_DATA_REQUEST, 검증 재시도 1회, Locked Spans 4개.

---

### Scenario 8: 알바직원/일정지연, 공지

**Original text**:

이번 주 스케줄 안 나온 건 내가 일부러 늦게 준 게 아니라 본사에서 아직 확정을 안 줘서 그런 거임. 나도 계속 전화 돌리고 있음. 근데 단톡방에 자꾸 언제 나오냐고 재촉하면 나도 난감함. 일단 금요일까지는 줄 건데, 그 전에 다른 알바 잡는 건 알아서 판단해도 됨.

**세그먼테이션 결과**:

| # | ID | Text | Length |
|---|-----|------|--------|
| 1 | T1 | 이번 주 스케줄 안 나온 건 내가 일부러 늦게 준 게 아니라 본사에서 아직 확정을 안 줘서 그런 거임 | 56 |
| 2 | T2 | 나도 계속 전화 돌리고 있음 | 15 |
| 3 | T3 | 근데 단톡방에 자꾸 언제 나오냐고 재촉하면 나도 난감함 | 30 |
| 4 | T4 | 일단 금요일까지는 줄 건데 | 14 |
| 5 | T5 | 그 전에 다른 알바 잡는 건 알아서 판단해도 됨 | 26 |

- **총 세그먼트 수**: 5
- **세그먼테이션 평가**: 전반적으로 양호. 각 문장별 분리가 적절. T1이 SELF_JUSTIFICATION + ACCOUNTABILITY 두 기능을 포함하나 연결 구조상 분리가 어려워 수용 가능.

**라벨링 결과**:

| ID | Tier | Label | Text (전문) |
|----|------|-------|------------|
| T1 | YELLOW | SELF_JUSTIFICATION | 이번 주 스케줄 안 나온 건 내가 일부러 늦게 준 게 아니라 본사에서 아직 확정을 안 줘서 그런 거임 |
| T2 | YELLOW | SELF_JUSTIFICATION | 나도 계속 전화 돌리고 있음 |
| T3 | YELLOW | EMOTIONAL | 근데 단톡방에 자꾸 언제 나오냐고 재촉하면 나도 난감함 |
| T4 | GREEN | CORE_FACT | 일단 금요일까지는 줄 건데 |
| T5 | GREEN | CORE_INTENT | 그 전에 다른 알바 잡는 건 알아서 판단해도 됨 |

- **GREEN**: 2 / **YELLOW**: 3 / **RED**: 0

**라벨링 적절성 평가**:

1. **GREEN 정확성 — WARN**: T5 "알아서 판단해도 됨"이 GREEN(CORE_INTENT)으로 분류되었으나, "알아서"는 Verification Points에서 "dismissive"로 명시된 표현. 상대방에게 책임을 떠넘기는 뉘앙스가 있어 YELLOW(NEGATIVE_FEEDBACK)이 더 적절. GREEN 보존 시 무관심/냉소적 톤이 그대로 전달될 위험.
2. **YELLOW 정확성 — WARN**: T3 "단톡방에 자꾸 재촉하면 나도 난감함"은 상대방 행동에 대한 간접 비판("자꾸 재촉하면") + 감정 표현("난감함") 혼합. EMOTIONAL보다 NEGATIVE_FEEDBACK이 지배적 기능에 더 부합. "재촉하면"은 상대 행동 지적 하드 트리거.
3. **RED 정확성 — PASS**: RED 분류 없음. 이 시나리오에서 RED 대상은 없어 정상.
4. **경계 사례 판단 — WARN**: T4 "금요일까지는 줄 건데"는 약속/의지 표현으로 CORE_INTENT가 CORE_FACT보다 적합 (사실 전달이 아니라 행동 의지). 경미한 서브라벨 이슈.
5. **RedLabelEnforcer — PASS**: 해당 패턴 없어 미개입, 정상.

**Rating: WARN**

핵심 이슈: (1) T5 "알아서 판단해도 됨" GREEN 과소 분류 — dismissive 표현이 톤 변환 없이 보존, (2) T3 서브라벨 EMOTIONAL→NEGATIVE_FEEDBACK 정밀도 부족.

파이프라인 통계: 총 지연 11,592ms, 템플릿 T04_SCHEDULE, 검증 재시도 0회, WARNING 1건(SOFTEN_CONTENT_DROPPED: T3).

---

### Scenario 14: 브랜드(협찬)/피드백, 계약

**Original text**:

영상 조회수 기대만큼 안 나온 건 알고리즘 영향이 큼. 콘텐츠 퀄리티가 낮아서라기보단 최근 채널 전체 노출이 줄어든 상황임. 계약상 업로드 의무는 이행했고, 추가 홍보는 옵션임. 다음 캠페인은 방향을 다시 잡아야 할 듯함.

**세그먼테이션 결과**:

| # | ID | Text | Length |
|---|-----|------|--------|
| 1 | T1 | 영상 조회수 기대만큼 안 나온 건 알고리즘 영향이 큼 | 30 |
| 2 | T2 | 콘텐츠 퀄리티가 낮아서라기보단 최근 채널 전체 노출이 줄어든 상황임 | 37 |
| 3 | T3 | 계약상 업로드 의무는 이행했고, 추가 홍보는 옵션임 | 28 |
| 4 | T4 | 다음 캠페인은 방향을 다시 잡아야 할 듯함 | 23 |

- **총 세그먼트 수**: 4
- **세그먼테이션 평가**: 문장 단위 깔끔한 분리. 이슈 없음.

**라벨링 결과**:

| ID | Tier | Label | Text (전문) |
|----|------|-------|------------|
| T1 | YELLOW | ACCOUNTABILITY | 영상 조회수 기대만큼 안 나온 건 알고리즘 영향이 큼 |
| T2 | YELLOW | ACCOUNTABILITY | 콘텐츠 퀄리티가 낮아서라기보단 최근 채널 전체 노출이 줄어든 상황임 |
| T3 | GREEN | CORE_FACT | 계약상 업로드 의무는 이행했고, 추가 홍보는 옵션임 |
| T4 | GREEN | CORE_INTENT | 다음 캠페인은 방향을 다시 잡아야 할 듯함 |

- **GREEN**: 2 / **YELLOW**: 2 / **RED**: 0

**라벨링 적절성 평가**:

1. **GREEN 정확성 — PASS**: T3, T4 모두 적절. T3은 계약 사실 전달, T4는 건설적 미래 제안.
2. **YELLOW 정확성 — WARN**: T2 "콘텐츠 퀄리티가 낮아서라기보단"은 "~라기보단" 방어적 부정 하드 트리거 → SELF_JUSTIFICATION이 기대값. ACCOUNTABILITY(외부 귀책)보다 SELF_JUSTIFICATION(방어적 부정)이 이 구조에 더 부합. T1은 외부 원인 귀속으로 ACCOUNTABILITY 적절.
3. **RED 정확성 — PASS**: RED 대상 없음, 정상.
4. **경계 사례 판단 — PASS**: T3 "업로드 의무는 이행했고"의 자기변호적 용법은 경계 사례이나 GREEN(CORE_FACT) 판단 수용 가능. "추가 홍보는 옵션임"의 암묵적 거절 뉘앙스도 계약 사실 전달로서 GREEN 허용 범위.
5. **RedLabelEnforcer — PASS**: 해당 패턴 없어 미개입, 정상.

**Rating: PASS (with notes)**

경미한 이슈: T2 서브라벨 ACCOUNTABILITY→SELF_JUSTIFICATION 정밀도. "~라기보단" 방어적 부정 구조가 ACCOUNTABILITY로 분류됨. Final Transform 영향은 제한적 — 두 라벨 모두 YELLOW이므로 재구성 처리됨.

파이프라인 통계: 총 지연 11,544ms, 템플릿 T08_FEEDBACK, 검증 재시도 0회.

---

## Overall Analysis

### 3-1. 분절 품질 요약

| 패턴 | 해당 시나리오 | 설명 |
|------|-------------|------|
| 호칭+내용 미분리 | 시나리오 3 (T1) | "고객님"(COURTESY)과 ACCOUNTABILITY 내용이 결합. 이전 로그(S3 T1, S4 T1)에서도 동일 패턴 반복. **반복 패턴 확인** |
| 불완전 문장 경계 분리 | 시나리오 3 (T2/T3) | "건드리지 말라" + "했는데 또 수정하셔서" — 연결어미 위치에서 분리. 이전 로그에서도 동일 이슈 지적됨. **반복 패턴 확인** |
| 나열형 혼합 콘텐츠 | 시나리오 3 (T4) | 이전 로그 대비 100자→66자로 개선(REQUEST 부분 T5 분리). 그러나 CORE_FACT + NEGATIVE_FEEDBACK 혼합 잔존 |

시나리오 8, 14는 세그먼테이션 품질 양호. 시나리오 3에 분절 이슈 집중 (이전 로그와 동일 패턴).

### 3-2. 라벨링 품질 요약

**반복 오라벨링 패턴**:

| 패턴 | 해당 시나리오 | 설명 | 영향 |
|------|-------------|------|------|
| **ACCOUNTABILITY vs NEGATIVE_FEEDBACK 서브라벨 혼동** | 시나리오 3 (T2/T3), 시나리오 14 (T2) | 상대방 행동에 대한 직접적 비판/지시가 ACCOUNTABILITY로 분류. ACCOUNTABILITY는 외부 원인 귀속이고, 상대 행동 판단은 NEGATIVE_FEEDBACK이 정확. | **중간** — 두 라벨 모두 YELLOW이므로 tier는 동일하나, 서브라벨에 따라 Final Transform의 재구성 전략(tone-down vs reframe)이 달라질 수 있음 |
| **Dismissive 표현 GREEN 과소 분류** | 시나리오 8 (T5) | "알아서 판단해도 됨"이 GREEN(CORE_INTENT)으로 분류. "알아서"의 무관심/냉소 뉘앙스가 미포착되어 톤 변환 없이 보존됨 | **심각** — 수신자에게 냉소적 인상을 주는 표현이 정중 변환 결과에 그대로 전달. 이전 로그의 "갈아엎든지 하죠" GREEN 과소 분류와 **동일 패턴** (투척형/체념형 → GREEN) |
| **혼합 콘텐츠 under-labeling** | 시나리오 3 (T4) | CORE_FACT(연락처) + NEGATIVE_FEEDBACK("환불 얘기는 좀 과한 것 같고")가 하나의 세그먼트에서 GREEN으로 통합 | **중간** — 세그먼테이션 의존 이슈. NEGATIVE_FEEDBACK 부분이 GREEN으로 보존되어 부정적 판단이 톤 변환 없이 전달 |

**FAIL 항목 상세**:

#### 1. 시나리오 8 T5: "그 전에 다른 알바 잡는 건 알아서 판단해도 됨"
- **실제**: GREEN(CORE_INTENT) → **기대**: YELLOW(NEGATIVE_FEEDBACK)
- **근거**: "알아서 판단해도 됨"은 표면적으로 자율성 부여이나, 맥락상 "난 책임 안 진다"는 dismissive 뉘앙스. Verification Points에서 "알아서"를 dismissive로 명시. 이전 로그에서 지적된 "갈아엎든지 하죠" GREEN 과소 분류와 동일 유형 — 체념/무관심 표현의 GREEN 분류 패턴 반복.
- **Final Transform 영향**: GREEN 보존 시 "알아서 판단해도 됨"이 그대로 전달되어 수신자에게 냉소적/무책임 인상. YELLOW 처리 시 "상황에 맞게 판단해 주시면 감사하겠습니다" 등 정중 프레이밍 전환 가능.

#### 2. 시나리오 3 T4: "환불 얘기는 좀 과한 것 같고" (혼합 세그먼트 내)
- **실제**: GREEN(CORE_INTENT) 내 포함 → **기대**: 별도 세그먼트로 YELLOW(NEGATIVE_FEEDBACK)
- **근거**: "환불 얘기는 좀 과한 것 같고"는 고객 요청에 대한 직접 판단/거절 하드 트리거. 연락처/계좌 정보(CORE_FACT)와 동일 세그먼트에 포함되어 GREEN으로 통합 분류.
- **Final Transform 영향**: 실제 출력에서 "환불 요청 관련해서는 현재 상황과 다른 부분이 있어 재논의가 필요할 것으로 판단됩니다"로 변환 — Final Transform이 내부적으로 톤 조정을 했으나, 라벨링 단계에서의 정확한 분류가 더 안정적인 결과를 보장.

### 3-3. 개선 제안

#### 우선순위 1: System prompt 수정

**1-1. Dismissive/체념형 표현 GREEN 과소 분류 방지** (시나리오 8 T5, 이전 S2 T12)

- **대상 파일**: `app/pipeline/prompt_builder.py` — StructureLabel 프롬프트
- **변경 내용**: GREEN 함정 규칙에 "dismissive 자율성" 패턴 추가:
  ```
  GREEN 함정: "알아서 해", "알아서 판단해", "알아서 하세요" 등은 표면상 자율성 부여이지만
  실제 기능은 책임 회피/냉소 → YELLOW(NEGATIVE_FEEDBACK).
  "~든지 하죠", "~든 말든" 등 체념형도 동일 → YELLOW(EXCESS_DETAIL).
  ```
  이전 로그에서 제안된 "GREEN 함정 5"와 통합. "알아서" 패턴을 명시적으로 추가.

**1-2. ACCOUNTABILITY vs NEGATIVE_FEEDBACK 서브라벨 구분 강화** (시나리오 3 T2/T3, 시나리오 14 T2)

- **대상 파일**: `app/pipeline/prompt_builder.py` — StructureLabel 프롬프트
- **변경 내용**: 두 서브라벨 판별 기준 명확화:
  ```
  ACCOUNTABILITY: 외부 원인/제3자에 원인 귀속 ("본사에서 확정을 안 줘서", "알고리즘 영향이 큼")
  NEGATIVE_FEEDBACK: 수신자/상대방 행동에 대한 직접 판단/비판 ("건드리지 말라고 했는데 또 수정하셔서", "환불 얘기는 좀 과한 것 같고")

  자문: 원인을 제3자/외부 요인에 돌리는가? → ACCOUNTABILITY
  자문: 수신자의 행동/판단을 평가하는가? → NEGATIVE_FEEDBACK
  ```

#### 우선순위 2: Server rule 강화

**2-1. MeaningSegmenter 호칭 분리 규칙 추가** (시나리오 3 T1, 이전 S3 T1/S4 T1)

- **대상 파일**: `app/pipeline/segmentation/meaning_segmenter.py`
- **변경 내용**: 호칭 패턴("고객님", "교수님", "선생님" 등)이 세그먼트 시작부에 있고 뒤에 본문 내용이 따를 때, 호칭을 별도 세그먼트로 분리하는 규칙 추가. **반복 패턴 (2회 이상 지적)으로 우선도 상향.**

**2-2. MeaningSegmenter 연결어미 분리 억제** (시나리오 3 T2/T3, 이전 동일 이슈)

- **대상 파일**: `app/pipeline/segmentation/meaning_segmenter.py`
- **변경 내용**: "-라(고) 했는데" 패턴이 의미 단위 중간에서 분리되지 않도록 ambiguous ending suppression 목록에 추가.

#### 우선순위 3: Pipeline 구조 변경

현재까지 발견된 이슈는 우선순위 1, 2에서 해결 가능하므로 구조 변경 불필요. 이전 로그에서 발생한 Gemini API 에러는 이번 실행에서 해결 확인 (시나리오 3 labeling 정상 완료).

---

## Changes vs Previous Log

### 이전 로그 (2026-02-23 21:19:22) 대비 비교

| 이전 이슈 | 현재 상태 | 비고 |
|----------|---------|------|
| Gemini API 에러 (S3 labeling 실패) | **해결됨** | `b4891c7`, `c69c9ec` 커밋에서 thinking config 수정. S3 labeling 정상 완료 |
| S3 T4 과소 분리 (100자, 3개 기능 혼합) | **일부 개선** | 66자로 축소 (REQUEST 부분 T5 분리). CORE_FACT + NEG_FEEDBACK 혼합은 잔존 |
| S3 T1 호칭+내용 미분리 | **미해결** | 동일 패턴 지속. S4 T1(교수님)과 함께 반복 패턴 확인됨 |
| S3 T2/T3 불완전 문장 경계 분리 | **미해결** | 동일 패턴 지속 |
| EMOTIONAL→PURE_GRUMBLE RED 과대 분류 (S2 T5, S4 T7) | **미검증** | 이번 실행에 S2, S4 미포함. 추후 재검증 필요 |
| 투척형/체념형 GREEN 과소 분류 (S2 T12) | **동일 패턴 재발** | S8 T5 "알아서 판단해도 됨"에서 dismissive 표현 GREEN 분류. 동일 유형 반복 확인 |
| RedLabelEnforcer "ㅃㅃ" 패턴 누락 (S1 T6) | **미검증** | 이번 실행에 S1 미포함. 추후 재검증 필요 |

### 신규 발견 이슈

| 이슈 | 시나리오 | 심각도 |
|------|---------|--------|
| ACCOUNTABILITY vs NEGATIVE_FEEDBACK 서브라벨 혼동 | S3 (T2/T3), S14 (T2) | 중간 |
| Dismissive "알아서" GREEN 과소 분류 | S8 (T5) | 심각 (반복 패턴) |
