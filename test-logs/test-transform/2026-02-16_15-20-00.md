# 파이프라인 변환 품질 테스트 결과

## 메타데이터

- **실행 시각**: 2026-02-16 15:20 KST
- **Git commit**: 5bdbbaa (main)
- **실행 시나리오**: 1, 2, 3, 4 (전체)
- **이전 로그**: 없음 (첫 실행)

## 코드 컨텍스트

### 최근 백엔드 변경 이력

```
5bdbbaa feat: enhance pipeline prompts, always-on RelationIntent, semantic RED reentry detection
2b53e44 feat: pipeline v2 — template system, context gating, JSON segment format, enhanced validation
63e19fa chore: remove stale comment in application.properties
```

### 파이프라인 구조 요약

| Component | Model | Temp | Max Tokens | Purpose |
|-----------|-------|------|-----------|---------|
| StructureLabelService | gpt-4o-mini | 0.2 | 800 | 3계층 라벨링 |
| SituationAnalysisService | gpt-4o-mini | 0.2 | 500 | 상황 분석 (always-on) |
| IdentityLockBooster | gpt-4o-mini | 0.2 | 300 | 의미적 고정 스팬 (optional) |
| ContextGatingService | gpt-4o-mini | 0.2 | 300 | 메타데이터 검증 (optional) |
| LlmSegmentRefiner | gpt-4o-mini | 0.0 | 600 | 장문 세그먼트 정제 (conditional) |
| **Final Transform** | **gpt-4o-mini** | **0.85** | **2000** | **최종 변환** |

### 주요 application.properties

```properties
openai.model=gpt-4o-mini
openai.temperature=0.85
openai.max-tokens=2000
```

---

## 시나리오별 결과

### 시나리오 1: 학부모/피드백

**입력**: PARENT / FEEDBACK / POLITE
**원문**: "안녕하쇼 담임임. 님 애가 시험을 망해서 놀라셨죠..."

**라벨링 결과**:

| ID | Tier | Label | 텍스트 (앞 30자) |
|---|---|---|---|
| T1 | GREEN | COURTESY | 안녕하쇼 담임임 |
| T2 | GREEN | CORE_FACT | 님 애가 시험을 망해서 놀라셨죠 |
| T3 | YELLOW | SELF_JUSTIFICATION | 근데 내 탓하려고 시동걸거 같아서 말해두는데 |
| T4 | YELLOW | ACCOUNTABILITY | 난 숙제도 제대로 내주고 진도 따라서 스터디 플랜도 잘 짜줬다 |
| T5 | YELLOW | NEGATIVE_FEEDBACK | 근데 님 애가 안 쳐한거임 |
| T6 | RED | PERSONAL_ATTACK | 학원 바꿀꺼면 머 ㅃㅃ인데 못바꾸잔아 |
| T7 | YELLOW | NEGATIVE_FEEDBACK | 걍 다음에 잘 보고 싶으면 님도 애를 좀 잡아봐 숙제를 하게 |

**맥락 분석**: 담임 교사→학부모 피드백, 학생 숙제 미참여 사실 전달 + 가정 협력 요청

**최종 변환 결과**:

> 안녕하세요, 담임입니다.
>
> 아이의 학습 상황을 살펴보니, 최근 시험에서 좋은 성적을 거두지 못한 점에 대해 놀라셨을 것 같습니다. 말씀드리기 조심스럽지만, 우리 반에서는 숙제를 충실히 내주고 진도에 맞춘 스터디 플랜도 잘 마련해드리고 있습니다. 하지만 확인해본 결과, 학생이 숙제를 제출하지 않은 상황이었습니다.
>
> 이런 점을 함께 고민해 보면 좋을 것 같아서, 학부모님께서도 학생이 숙제를 하도록 지도해 주시면 감사하겠습니다. 그럴 경우, 다음 시험에서는 더 나은 결과를 기대할 수 있을 것 같습니다.
>
> 감사합니다.

**통계**: 7 세그먼트 (G2/Y4/R1) | 고정스팬 0 | 재시도 0 | 템플릿 T08_FEEDBACK | 17.6초 | $0.0019

**검증**: PASS (이슈 0건)

**품질 평가**:

| # | 기준 | 결과 | 비고 |
|---|------|------|------|
| 1 | 라벨링 적절성 | PASS | |
| 2 | 의미 보존 | PASS | 숙제/스터디플랜/진도/시험 모두 보존 |
| 3 | RED 처리 | PASS | "ㅃㅃ" 포함 조롱 완전 삭제 |
| 4 | YELLOW 재작성 | PASS | 방어→협력 프레임 전환 적절 |
| 5 | 톤 적절성 | PASS | 교사→학부모 전문적 공감 톤 |
| 6 | 고정 표현 보존 | PASS | (해당 없음) |
| 7 | 자연스러움 | **WARN** | "것 같-" 패턴 3회 반복 |
| 8 | 청자 관점 적절성 | PASS | 존중+협력 요청 명확 |
| 9 | 종합 표현/상황 적절성 | PASS | 실제 발송 가능 수준 |

---

### 시나리오 2: 직장상사/사과, 항의

**입력**: BOSS / APOLOGY+COMPLAINT / POLITE
**원문**: "솔직히 말해서 이번 일정 또 밀린거 저 때문만은 아니고..."

**라벨링 결과**:

| ID | Tier | Label | 텍스트 (앞 30자) |
|---|---|---|---|
| T1 | YELLOW | SELF_JUSTIFICATION | 솔직히 말해서 이번 일정 또 밀린거 저 때문만은 아니고 |
| T2 | YELLOW | ACCOUNTABILITY | PR-482도 아직 안 닫혔고 |
| T3 | YELLOW | ACCOUNTABILITY | 김민수도 답을 안 줬고 |
| T4 | YELLOW | ACCOUNTABILITY | 그래서 v2.3.1 배포가 지금 이 꼴 난건데 |
| T5 | YELLOW | SELF_JUSTIFICATION | 아무튼 제가 다 책임져야 하는 분위기라 좀 억울하긴 합니다 |
| T6 | GREEN | CORE_INTENT | 오늘 18:00 전에 report_final_v3.docx는 올리긴 올릴거고 |
| T7 | GREEN | CORE_FACT | 링크는 https://drive.company.com/alpha 이거고 |
| T8 | GREEN | CORE_FACT | 제 이메일은 alpha.team.lead@company.co.kr 인데 |
| T9 | YELLOW | SELF_JUSTIFICATION | 사실 어제도 새벽 3시까지 했고 |
| T10 | RED | PRIVATE_TMI | 허리도 아프고 |
| T11 | RED | PURE_GRUMBLE | 이거 계속 이런식이면 저도 진짜 모르겠습니다 |
| T12 | GREEN | CORE_INTENT | 일단 오늘은 넘기고 나중에 구조 다시 갈아엎든지 하죠 |

**맥락 분석**: 부하→상사 일정 지연 보고, 복합 요인 설명 + 제출 약속

**최종 변환 결과**:

> 안녕하세요.
>
> 말씀해 주신 내용 확인했습니다. 이번 일정이 또 밀린 점에 대해 유감스럽게 생각하며, 저로 인한 부분만은 아니지만 여러 외부 요인으로 인해 억울한 감정이 드는 부분이 있습니다. PR-482도 아직 닫히지 않았고, 김민수의 답변이 없었던 상황이 있어서 v2.3.1 배포가 이렇게 된 것으로 파악하고 있습니다. 따라서 저에게 모든 책임이 돌아오는 분위기가 되어 조금 억울한 기분이 드는 점 양해 부탁드립니다.
>
> 하지만 오늘 18:00 전에 report_final_v3.docx는 꼭 올릴 계획입니다. 링크는 https://drive.company.com/alpha 이며, 제 이메일은 alpha.team.lead@company.co.kr입니다. 사실 어제도 새벽 3시까지 작업을 진행했으니, 이번 일은 꼭 마무리 짓도록 하겠습니다. 일단 오늘은 상황을 넘기고, 나중에 다시 구조를 개선하는 방향으로 검토해 보겠습니다.
>
> 감사합니다.
>
> [이름] 드림.

**통계**: 12 세그먼트 (G4/Y6/R2) | 고정스팬 7 | 재시도 0 | 템플릿 T05_APOLOGY | ContextGating 발동 | 23.8초 | $0.0023

**검증**: PASS (이슈 0건)

**품질 평가**:

| # | 기준 | 결과 | 비고 |
|---|------|------|------|
| 1 | 라벨링 적절성 | WARN | T12 GREEN 분류가 경계적 |
| 2 | 의미 보존 | WARN | T9 "새벽 3시" 순화 없이 잔존 |
| 3 | RED 처리 | WARN | RED 직접 재유입은 없으나 인접 맥락 잔존 |
| 4 | YELLOW 재작성 | **FAIL** | "억울" 2회 잔존, 방어적 표현 미순화 |
| 5 | 톤 적절성 | WARN | BOSS에게 "억울하다" 부적절 |
| 6 | 고정 표현 보존 | PASS | 7개 스팬 모두 보존 |
| 7 | 자연스러움 | WARN | "억울" 반복 |
| 8 | 청자 관점 적절성 | **FAIL** | 사과가 아닌 불만으로 읽힘 |
| 9 | 종합 표현/상황 적절성 | **FAIL** | 사과 주/항의 보조 비율 역전 |

**핵심 문제**: YELLOW(SELF_JUSTIFICATION) 세그먼트 재작성 실패. "억울하다"가 2회 그대로 남아 사과 메시지가 불만 메시지로 전락.

---

### 시나리오 3: 고객/요청, 피드백

**입력**: CLIENT / REQUEST+FEEDBACK / POLITE
**원문**: "고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단..."

**라벨링 결과**:

| ID | Tier | Label | 텍스트 (앞 30자) |
|---|---|---|---|
| T1 | YELLOW | ACCOUNTABILITY | 고객님 솔직히 말씀드리면 이번 오류는 저희 쪽 문제라기보단... |
| T2 | YELLOW | NEGATIVE_FEEDBACK | 제가 지난번에도 config.yaml이랑 MainService.java 건드리지 말라고... |
| T3 | GREEN | CORE_INTENT | 아무튼 현재 010-4921-8823으로 연락주셔도 되고 |
| T4 | GREEN | CORE_FACT | 계좌는 110-123-456789이고 |
| T5 | YELLOW | NEGATIVE_FEEDBACK | 환불 얘기는 좀 과한 것 같고 |
| T6 | GREEN | CORE_INTENT | 일단 로그파일 error_dump_2026_02_14.zip 보내주시면 제가 보겠습니다 |
| T7 | RED | PRIVATE_TMI | 근데 저도 사람이라 하루종일 이런 대응하면 멘탈 좀 나가긴 합니다 |

**맥락 분석**: 서비스 제공자→고객 오류 원인 설명 + 로그 요청 + 환불 대응

**최종 변환 결과**:

> 안녕하세요, 고객님.
>
> 말씀 주신 내용 확인했습니다. 이번 오류는 저희 측의 문제라기보다는 고객님의 서버 설정에 문제가 있어 발생한 것으로 보입니다. 제가 지난번에도 config.yaml과 MainService.java를 수정하지 말라고 말씀드렸는데, 다시 수정하신 부분에서 문제가 발생한 것 같습니다. 아무튼 현재 010-4921-8823으로 연락 주셔도 됩니다. 계좌는 110-123-456789입니다.
>
> 환불 요청은 다소 과한 점이 있는 것 같습니다. 일단 로그파일 error_dump_2026_02_14.zip을 보내주시면 제가 확인해 보겠습니다.
>
> 감사합니다. [이름] 드림.

**통계**: 7 세그먼트 (G3/Y3/R1) | 고정스팬 5 | 재시도 0 | 템플릿 T11_REFUND_REJECTION | ContextGating 발동 | 17.4초 | $0.0022

**검증**: PASS (이슈 0건)

**품질 평가**:

| # | 기준 | 결과 | 비고 |
|---|------|------|------|
| 1 | 라벨링 적절성 | PASS | |
| 2 | 의미 보존 | PASS | 연락처/계좌/파일명 보존 |
| 3 | RED 처리 | PASS | "멘탈" 발언 완전 삭제 |
| 4 | YELLOW 재작성 | **FAIL** | 비난 톤 거의 원문 유지, 쿠션/주어전환 부재 |
| 5 | 톤 적절성 | WARN | 고객에게 직접 지적 부적절 |
| 6 | 고정 표현 보존 | PASS | 5개 스팬 모두 보존 |
| 7 | 자연스러움 | WARN | "아무튼" 구어체 잔존, "[이름] 드림" hallucination |
| 8 | 청자 관점 적절성 | **FAIL** | 고객 공감 부재, 비난적 지적 반복 |
| 9 | 종합 표현/상황 적절성 | **FAIL** | CLIENT 대응에 부적절 |

**핵심 문제**: YELLOW(ACCOUNTABILITY/NEGATIVE_FEEDBACK) 순화 실패. 고객에게 원인을 고객 탓으로 돌리며 환불을 "과하다"고 직접 거부. 쿠션/공감 표현 전무.

---

### 시나리오 4: 교수/사과

**입력**: PROFESSOR / APOLOGY / POLITE
**원문**: "교수님 이번 과제 제출이 늦어진건 사실 제 잘못도 있지만..."

**라벨링 결과**:

| ID | Tier | Label | 텍스트 (앞 30자) |
|---|---|---|---|
| T1 | YELLOW | SELF_JUSTIFICATION | 교수님 이번 과제 제출이 늦어진건 사실 제 잘못도 있지 |
| T2 | YELLOW | EXCESS_DETAIL | JIRA-991 이 계속 꼬여서 그런거고 |
| T3 | RED | PRIVATE_TMI | 사실 개인적으로도 집안일이 좀 있었고 |
| T4 | RED | PRIVATE_TMI | 그래서 정신이 없었습니다 |
| T5 | GREEN | CORE_FACT | 결과물은 final_thesis_v1.0.4.pdf로 정리해놨 |
| T6 | GREEN | CORE_INTENT | https://snu-project-lab.com/upload 여기 업로드 예 |
| T7 | YELLOW | NEGATIVE_FEEDBACK | 솔직히 이런식으로 일정이 빡빡하면 연구 퀄리티가 떨어 |
| T8 | GREEN | CORE_FACT | UUID는 123e4567-e89b-12d3-a456-4266... 이고 |
| T9 | GREEN | APOLOGY | 어쨌든 늦은건 죄송하지만 |
| T10 | RED | PURE_GRUMBLE | 저만 탓받는 느낌은 좀 억울하네요 |

**맥락 분석**: 학생→교수 과제 지연 사과, JIRA 이슈 맥락 + 결과물 제출 약속

**최종 변환 결과**:

> 교수님,
>
> 이번 과제 제출이 늦어진 것에 대해 깊이 사과드립니다. 불편을 드린 점 유감이며, 개인적인 사정 또한 있었음을 말씀드리기 조심스럽습니다. 확인해본 결과, JIRA-991의 문제로 인해 일정이 원활하지 못했습니다. 그럼에도 불구하고 결과물은 final_thesis_v1.0.4.pdf로 정리하였으며, https://snu-project-lab.com/upload에 업로드할 예정입니다.
>
> 이와 같은 촉박한 일정은 연구의 퀄리티에 부정적인 영향을 미칠 수 있다고 생각합니다. 앞으로 더욱 신중하게 관리하도록 하겠습니다.
>
> 감사합니다.
>
> [이름] 올림

**통계**: 10 세그먼트 (G4/Y3/R3) | 고정스팬 4 | **재시도 1회** (LOCKED_SPAN_MISSING ERROR) | 템플릿 T05_APOLOGY | 11.3초 | $0.0020

**검증**: **FAIL** (재시도 후에도 ERROR 미해결)

| Severity | Type | 내용 |
|----------|------|------|
| ERROR | LOCKED_SPAN_MISSING | {{UUID_1}} ("123e4567-e89b-12d3-a456-426614174000") 누락 |
| WARNING | SOFTEN_CONTENT_DROPPED | SOFTEN 대상 내용 소실: "JIRA-991 이 계속 꼬여서 그런거고..." |

**품질 평가**:

| # | 기준 | 결과 | 비고 |
|---|------|------|------|
| 1 | 라벨링 적절성 | WARN | T1 사과+변호 혼합, T2 EXCESS_DETAIL 경계적 |
| 2 | 의미 보존 | **FAIL** | UUID 완전 누락 |
| 3 | RED 처리 | WARN | "개인적인 사정" 간접 재유입 |
| 4 | YELLOW 재작성 | WARN | T7 불만→조언요청 전환 부족 |
| 5 | 톤 적절성 | PASS | 학생→교수 경어체 적절 |
| 6 | 고정 표현 보존 | **FAIL** | UUID 누락 (재시도 후에도 미해결) |
| 7 | 자연스러움 | WARN | "-습니다" 7회 반복 |
| 8 | 청자 관점 적절성 | WARN | 불만 표출이 사과 진정성 훼손 |
| 9 | 종합 표현/상황 적절성 | WARN | 사과+불만 혼합 구조 |

**핵심 문제**: UUID 고정 스팬 누락 (재시도 후에도 미해결). RED/PRIVATE_TMI의 "개인 사정" 간접 재유입.

---

## 종합 분석

### 품질 평가 요약

| 기준 | S1 | S2 | S3 | S4 | 패턴 |
|------|----|----|----|----|------|
| 1. 라벨링 적절성 | PASS | WARN | PASS | WARN | |
| 2. 의미 보존 | PASS | WARN | PASS | **FAIL** | |
| 3. RED 처리 | PASS | WARN | PASS | WARN | S2,S4 인접 맥락 잔존 |
| 4. YELLOW 재작성 | PASS | **FAIL** | **FAIL** | WARN | **반복 패턴** (3/4 시나리오) |
| 5. 톤 적절성 | PASS | WARN | WARN | PASS | S2,S3 persona 부적합 |
| 6. 고정 표현 보존 | PASS | PASS | PASS | **FAIL** | |
| 7. 자연스러움 | WARN | WARN | WARN | WARN | **반복 패턴** (4/4 시나리오) |
| 8. 청자 관점 적절성 | PASS | **FAIL** | **FAIL** | WARN | **반복 패턴** (S2,S3) |
| 9. 종합 표현/상황 적절성 | PASS | **FAIL** | **FAIL** | WARN | **반복 패턴** (S2,S3) |

### 반복 실패 패턴

#### 패턴 1: YELLOW 재작성 전략 미작동 (S2 FAIL, S3 FAIL, S4 WARN)

**가장 심각한 반복 패턴.** YELLOW 세그먼트의 "쿠션→사실→방향" 재작성 전략이 Final LLM에서 거의 적용되지 않음.

- S2: "억울한 감정이 드는 부분이 있습니다" (원문 감정 그대로)
- S3: "고객님의 서버 설정에 문제가 있어" (쿠션/주어전환 없이 고객 직접 지적)
- S3: "환불 요청은 다소 과한 점이 있는 것 같습니다" (원문과 동일 뉘앙스)
- S4: "촉박한 일정은 연구의 퀄리티에 부정적인 영향을 미칠 수 있다" (불만 거의 유지)

**원인 추정**: Final 프롬프트(MultiModelPromptBuilder)의 YELLOW 라벨별 재작성 지침이 구체적이지 않아, LLM이 "톤만 약간 공손하게" 수준에서 멈추고 프레임 전환(방어→사실, 비난→요청, 감정→행동)을 수행하지 않음.

#### 패턴 2: 자연스러움 경미한 이슈 (S1~S4 모두 WARN)

- S1: "것 같-" 패턴 3회 반복
- S2: "억울" 2회 반복
- S3: "아무튼" 구어체 잔존
- S4: "-습니다" 어미 7회 반복

**원인 추정**: gpt-4o-mini의 한국어 어미 다양성 한계. temp=0.85에서도 동일 어미 패턴에 빠지는 경향.

#### 패턴 3: 청자 관점 부적절 (S2 FAIL, S3 FAIL)

- S2: 상사에게 "억울하다" 호소 → 사과가 아닌 불만 메시지
- S3: 고객에게 원인 직접 지적 + 환불 직접 거절 → 고객 관계 악화

**원인 추정**: Final LLM이 "수신자 관점에서의 인상"을 고려하지 않고, 원문의 화자 관점을 그대로 유지하며 톤만 경어체로 바꿈.

### FAIL 항목 상세 분석

#### S2 YELLOW 재작성 FAIL

- **문제 세그먼트**: T1(SELF_JUSTIFICATION), T5(SELF_JUSTIFICATION), T9(SELF_JUSTIFICATION)
- **기대 결과**: 방어적 변명 제거 → 사실 보고 + 책임감 표현 + 건설적 방향
- **실제 결과**: "억울한 감정" 2회, "새벽 3시까지" 자기연민 그대로 유지
- **원인**: SELF_JUSTIFICATION 라벨에 대한 재작성 지침이 "방어 프레임을 사실 중심으로 바꾸라" 수준이지만, LLM이 감정 단어("억울")를 사실로 인식하여 보존함
- **수신자 부정적 인상**: 상사가 "이 사람은 사과하면서도 억울해하고 있구나, 반성 의지가 없다"고 판단할 수 있음. 실무에서는 신뢰도 하락 + 추가 질책 가능성

#### S3 YELLOW 재작성 FAIL

- **문제 세그먼트**: T1(ACCOUNTABILITY), T2(NEGATIVE_FEEDBACK), T5(NEGATIVE_FEEDBACK)
- **기대 결과**: 쿠션 삽입 + 주어 전환(사람→사물) + 지적→요청 전환 + 직접 거부→대안 제시
- **실제 결과**: "고객님의 서버 설정에 문제가 있어" (고객 직접 지적), "환불 요청은 다소 과한 점" (직접 거부)
- **원인**: ACCOUNTABILITY/NEGATIVE_FEEDBACK 라벨에 대한 "쿠션→사실→방향" 전략이 프롬프트에 충분히 구체적으로 명시되지 않음
- **수신자 부정적 인상**: 고객이 "내 탓이라고 비난하면서 환불도 안 해준다"고 느낄 수 있음. 실무에서는 고객 이탈 + 부정 리뷰 가능성

#### S4 의미 보존 / 고정 표현 보존 FAIL

- **문제**: UUID(123e4567-e89b-12d3-a456-426614174000)가 1차/2차 생성 모두에서 누락
- **기대 결과**: "UUID는 123e4567-e89b-12d3-a456-426614174000입니다" 포함
- **실제 결과**: UUID 관련 문장 자체가 생략됨
- **원인**: Final LLM이 UUID를 의미 있는 정보로 인식하지 못하거나, 긴 UUID 문자열을 생략하는 경향. {{UUID_1}} 플레이스홀더 보존 지시가 프롬프트에서 충분히 강하지 않음

### Validation 이슈 분석

| 시나리오 | 이슈 | 재시도 |
|----------|------|--------|
| S1 | 없음 | 0 |
| S2 | 없음 | 0 |
| S3 | 없음 | 0 |
| S4 | LOCKED_SPAN_MISSING (ERROR) + SOFTEN_CONTENT_DROPPED (WARNING) | 1회 (미해결) |

- LOCKED_SPAN_MISSING이 S4에서 발생하여 재시도했으나 미해결. UUID 같은 긴 문자열의 보존 실패 패턴.
- 나머지 3개 시나리오는 Validation PASS이지만, 이는 **YELLOW 순화 실패가 Validation으로 감지되지 않기 때문**. Validator가 YELLOW 재작성 품질을 검증하지 않는 구조적 한계.

---

## 품질 개선 제안

### 우선순위 1: 시스템 프롬프트 수정

#### 1-1. YELLOW 라벨별 재작성 지침 강화 (가장 시급)

**수정 대상**: `MultiModelPromptBuilder.java` (Final 프롬프트의 YELLOW 재작성 섹션)

**구체적 변경**:

현재 YELLOW 재작성 지침이 추상적("쿠션→사실→방향")으로 되어 있으므로, 라벨별 구체적 금지/필수 규칙 추가:

- **SELF_JUSTIFICATION**:
  - 금지: 감정 단어(억울, 서럽다, 속상하다, 답답하다) 사용 금지
  - 금지: 자기 고생/노력 호소("새벽까지", "며칠째", "혼자서")
  - 필수: 방어 프레임을 사실 보고체로 전환 ("~로 인해 지연이 발생했습니다")
  - 필수: 감정 대신 책임감/해결 의지 표현 ("책임을 느끼며 ~ 하겠습니다")

- **ACCOUNTABILITY**:
  - 금지: 수신자를 주어로 한 비난 ("고객님이 ~하셔서", "귀사가 ~해서")
  - 필수: 주어를 사물/상황으로 전환 ("서버 설정 변경이", "파일 수정이")
  - 필수: 쿠션 삽입 ("확인 결과", "검토해 본 바")

- **NEGATIVE_FEEDBACK**:
  - 금지: 직접 거절/부정 ("과한 것 같습니다", "그건 아니고")
  - 필수: 지적→요청 전환 ("~해 주시면 감사하겠습니다")
  - 필수: 대안/방향 제시 ("먼저 ~를 확인한 후 안내드리겠습니다")

- **EMOTIONAL**:
  - 금지: 원문의 감정 단어 유지
  - 필수: 감정→행동/의지로 전환

#### 1-2. 수신자 관점 자가점검 지침 추가

**수정 대상**: `MultiModelPromptBuilder.java`

Final 프롬프트 마지막에 추가:

```
최종 점검: 수신자({persona})가 이 메시지를 받았을 때 비난/지적/불만으로 느끼지 않는지 확인하라.
- APOLOGY context: 사과가 주축이며, 변명/억울함이 사과를 압도하지 않는가?
- CLIENT persona: 고객 공감이 원인 설명보다 먼저 오는가?
- BOSS persona: 보고 톤이며 감정 호소가 없는가?
```

#### 1-3. 구어체 잔존 방지

**수정 대상**: `MultiModelPromptBuilder.java` 또는 AVOID_PHRASES 목록

"아무튼", "걍", "솔직히" 등 구어체 접속사를 AVOID_PHRASES에 추가하거나, "POLITE 이상 톤에서 구어체 접속사 사용 금지" 규칙 추가.

### 우선순위 2: 서버 전처리/후처리 보강

#### 2-1. YELLOW 감정 잔존 검사 규칙 추가

**수정 대상**: `OutputValidator.java`

새 규칙: `YELLOW_EMOTION_RETAINED` — SELF_JUSTIFICATION/EMOTIONAL 라벨 세그먼트의 핵심 감정 단어("억울", "속상", "답답", "서럽", "멘탈")가 최종 결과에 그대로 남아있는지 검증. WARNING 수준으로 발행, RETRYABLE_WARNING으로 1회 재시도 유도.

#### 2-2. UUID 보존 강화

**수정 대상**: `MultiModelPromptBuilder.java` 또는 `OutputValidator.java`

- Final 프롬프트에 "모든 {{...}} 플레이스홀더를 빠짐없이 포함하라. 하나라도 누락하면 실패다." 지침을 더 강조
- OutputValidator의 LOCKED_SPAN_MISSING 재시도 시 temp를 0.1로 더 낮추는 것 검토

#### 2-3. "[이름] 드림/올림" hallucination 방지

**수정 대상**: `OutputValidator.java`

새 규칙: senderInfo가 null/empty일 때 "[이름]", "[이름] 드림", "[이름] 올림" 같은 플레이스홀더가 생성되면 WARNING 발행. 또는 Final 프롬프트에 "senderInfo가 없으면 서명을 생성하지 마라" 명시.

### 우선순위 3: 파이프라인 구조 변경 검토

#### 3-1. Final 모델 4o-mini → 4o 업그레이드 검토 (사용자 요청 사항)

아래 별도 섹션에서 상세 분석.

---

## 모델 업그레이드 분석: gpt-4o-mini → gpt-4o

### 현재 구성

모든 6개 LLM 호출이 `gpt-4o-mini` 사용 중:

| 호출 | 모델 | 비용/1K tokens (input/output) |
|------|------|------|
| StructureLabelService | gpt-4o-mini | $0.15/$0.60 |
| SituationAnalysisService | gpt-4o-mini | $0.15/$0.60 |
| IdentityLockBooster | gpt-4o-mini | $0.15/$0.60 |
| ContextGatingService | gpt-4o-mini | $0.15/$0.60 |
| LlmSegmentRefiner | gpt-4o-mini | $0.15/$0.60 |
| **Final Transform** | **gpt-4o-mini** | **$0.15/$0.60** |

### 업그레이드 후보 분석

#### 후보 A: Final Transform만 4o로 업그레이드 (권장)

| 항목 | 현재 (4o-mini) | 변경 후 (4o) |
|------|---------------|-------------|
| 모델 | gpt-4o-mini | gpt-4o |
| 비용/1K tokens | $0.15/$0.60 | $2.50/$10.00 |
| **비용 배수** | 1x | **~17x (해당 호출만)** |
| 예상 호출당 비용 | ~$0.0015 | ~$0.025 |

**예상 효과 (높음)**:

이번 테스트의 핵심 실패 원인이 **YELLOW 재작성 품질**인데, 이는 Final Transform의 지시 이해력 + 한국어 뉘앙스 처리 능력에 직결됨.

- gpt-4o는 한국어 맥락 이해 + 미묘한 톤 전환에서 4o-mini 대비 유의미한 성능 차이가 있음
- "쿠션→사실→방향" 같은 복합 재작성 전략은 모델의 instruction following 능력에 크게 의존
- "억울" 감정 제거 + 프레임 전환 같은 고차원 재작성은 4o가 확실히 더 잘 수행할 것으로 예상
- UUID 보존 같은 단순 지시 준수도 4o에서 더 안정적

**비용 영향**: 호출당 ~$0.0015 → ~$0.025 (약 17배 증가). 단, 전체 파이프라인 비용에서 Final은 약 60%를 차지하므로, 전체 비용은 약 $0.002 → $0.028 (약 14배).

**결론**: YELLOW 재작성 실패가 반복 패턴이고 프롬프트 최적화만으로 해결이 불확실한 상황에서, Final을 4o로 올리는 것은 가장 확실한 품질 개선 경로. 다만 비용이 14배 증가하므로, 프롬프트 최적화를 먼저 시도하고 그래도 부족하면 업그레이드하는 단계적 접근을 권장.

#### 후보 B: StructureLabelService도 4o로 업그레이드

**예상 효과 (낮음~중간)**:

이번 테스트에서 라벨링 적절성은 대부분 PASS/WARN으로, 심각한 라벨링 오류는 없었음. S2의 T12(GREEN 경계적), S4의 T1(혼합 세그먼트) 정도가 경계적이었으나, 이는 분절 단계의 문제이지 라벨링 모델의 한계는 아님.

- 비용: StructureLabel 호출당 ~$0.001 → ~$0.017
- 효과 대비 비용이 높고, 현재 라벨링 품질이 수용 가능한 수준이므로 업그레이드 우선순위 낮음

**결론**: 현 시점에서 불필요.

#### 후보 C: SituationAnalysisService를 4o로 업그레이드

**예상 효과 (낮음)**:

SituationAnalysis는 사실 추출 + 의도 파악 용도로, 현재 4o-mini에서도 잘 작동하고 있음. 추출된 사실이 부정확한 사례가 이번 테스트에서 관찰되지 않았음.

**결론**: 현 시점에서 불필요.

### 최종 권장안

```
단계 1 (즉시): Final 프롬프트 YELLOW 재작성 지침 강화 (비용 0원)
단계 2 (즉시): OutputValidator에 YELLOW 감정 잔존 검사 추가 (비용 0원)
단계 3 (테스트 후): 프롬프트 최적화 후 재테스트하여 개선 폭 확인
단계 4 (필요시): Final Transform만 gpt-4o로 업그레이드 (비용 ~14배)
```

프롬프트 최적화(단계 1-2)로 YELLOW 재작성이 개선되면 모델 업그레이드 없이도 충분할 수 있음. 그래도 부족하면 Final만 4o로 올리는 것이 비용 대비 효과가 가장 높은 선택.

---

## 이전 로그 대비 변화

이전 로그 없음 (첫 실행). 향후 비교 기준으로 활용.
